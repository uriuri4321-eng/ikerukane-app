<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <link href="https://fonts.googleapis.com/earlyaccess/nicomoji.css" rel="stylesheet">
    <title>ã‚¤ã‚±ãƒ«ã‚«ãƒ</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- æ™‚é–“å¸¯ã«å¿œã˜ãŸèƒŒæ™¯è‰²å¤‰æ›´ -->
    <script src="js/background-time.js"></script>
</head>

<body>
    <h1 class="main-title">ã‚¤ã‚±ãƒ«ã‚«ãƒ</h1>
    <p class="catch">
        ãŠé‡‘ã®æŠ‘æ­¢åŠ›ã§<br>
        é…åˆ»ã‚’ã•ã›ãªã„
    </p>
    <img src="images/cloud1.png" class="cloud1">
    <img src="images/cloud2.png" class="cloud2">

    <div id="loginSection">
        <div class="login-content">
            <button id="closeLoginSection">Ã—</button>
            <h2>ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</h2>
            
            <!-- æ³¨æ„æ–‡ -->
            <div class="browser-warning" style="background: #fff3cd; border-left: 4px solid #FF9800; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; line-height: 1.6; color: #856404;">
                <strong>âš ï¸ æ³¨æ„</strong><br>
                ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯æ­£å¸¸ã«å‹•ä½œã—ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚Safariã‚„Chromeãªã©ã«åˆ‡ã‚Šæ›¿ãˆã¦ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
            </div>
            
            <!-- Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ -->
            <div id="googleSignInButton"></div>
            <div class="login-divider">ã¾ãŸã¯</div>
            
            <!-- ãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ­ã‚°ã‚¤ãƒ³ -->
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="login-submit-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
            </form>
            <div class="register-link">
                <a href="#" id="showRegisterLink">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²ã¯ã“ã¡ã‚‰</a>
            </div>
        </div>
    </div>
    
    <div class="login-buttons-area" id="loginButtonsArea">
        <button id="showLoginButton">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <a href="register.html" id="registerLink">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²</a>
    </div>
    
    <!-- ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã®ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
    <div class="login-buttons-area" id="loggedInButtonsArea" style="display: none;">
        <button id="startButton">å§‹ã‚ã‚‹</button>
        <button id="logoutButton">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
    
    <div id="map"></div>
    
    <!-- ç®¡ç†è€…é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="adminChoiceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); z-index: 1500; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch;">
        <div id="adminChoiceModalContent" style="max-width: 400px; margin: 50px auto; padding: 32px; background: var(--bg-white); border-radius: var(--radius-md); box-shadow: var(--shadow-xl); position: relative; box-sizing: border-box;">
            <h2 style="text-align: center; margin-bottom: 24px; color: var(--text-primary); font-size: 24px; font-weight: 700;">ğŸ” ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h2>
            <p style="text-align: center; margin-bottom: 32px; color: var(--text-secondary); line-height: 1.6;">
                ç®¡ç†è€…ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚<br>
                ã©ã¡ã‚‰ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ
            </p>
            <div style="display: flex; flex-direction: column; gap: 16px;">
                <button id="goToAdminDashboardBtn" style="background: linear-gradient(135deg, var(--danger-color) 0%, var(--danger-dark) 100%); color: white; padding: 16px 32px; border: none; border-radius: var(--radius-md); font-size: 18px; font-weight: 700; cursor: pointer; transition: all var(--transition-normal); box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);">
                    ğŸ“Š ç®¡ç†ç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                </button>
                <button id="goToCalendarBtn" style="background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%); color: white; padding: 16px 32px; border: none; border-radius: var(--radius-md); font-size: 18px; font-weight: 700; cursor: pointer; transition: all var(--transition-normal); box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);">
                    ğŸ“… äºˆå®šè¨­å®šç”»é¢
                </button>
            </div>
        </div>
    </div>
    
    <!-- ä½ç½®æƒ…å ±ã®å–ã‚Šæ‰±ã„ã«é–¢ã™ã‚‹åŒæ„ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="locationConsentModal">
        <div id="locationConsentModalContent">
            <h2>ğŸ“ ä½ç½®æƒ…å ±ã®å–ã‚Šæ‰±ã„ã«é–¢ã™ã‚‹åŒæ„</h2>
            <div id="locationConsentText">
                <p style="margin-bottom: 15px; font-weight: bold; color: var(--danger-color);">é‡è¦ï¼šæœ¬ã‚¢ãƒ—ãƒªã‚’ä½¿ç”¨ã™ã‚‹å‰ã«ã€ä»¥ä¸‹ã®å†…å®¹ã‚’å¿…ãšãŠèª­ã¿ãã ã•ã„ã€‚</p>
                
                <h3>1. ä½ç½®æƒ…å ±ã®åé›†ã«ã¤ã„ã¦</h3>
                <p>æœ¬ã‚¢ãƒ—ãƒªã¯ã€äºˆå®šã®ç›®çš„åœ°ã¸ã®åˆ°ç€ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã€ãŠå®¢æ§˜ã®ä½ç½®æƒ…å ±ï¼ˆGPSæƒ…å ±ï¼‰ã‚’åé›†ãƒ»åˆ©ç”¨ã—ã¾ã™ã€‚ä½ç½®æƒ…å ±ã¯ã€äºˆå®šã®æœŸæ—¥ã¾ã§ã«ç›®çš„åœ°ã«åˆ°ç€ã—ãŸã‹ã©ã†ã‹ã‚’è‡ªå‹•åˆ¤å®šã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</p>
                
                <h3>2. ç®¡ç†è€…ã«ã‚ˆã‚‹ä½ç½®æƒ…å ±ã®é–²è¦§ã«ã¤ã„ã¦</h3>
                <p style="color: var(--danger-color); font-weight: bold;">æœ¬ã‚¢ãƒ—ãƒªã®ç®¡ç†è€…ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã®ç®¡ç†ãƒ»é‹å–¶ã®ãŸã‚ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½ç½®æƒ…å ±ã‚’é–²è¦§ã§ãã‚‹æ¨©é™ã‚’æœ‰ã—ã¦ã„ã¾ã™ã€‚</p>
                <p>ä½ç½®æƒ…å ±ã¯æš—å·åŒ–ãªã©ã®æŠ€è¡“çš„ä¿è­·æªç½®ã‚’è¬›ã˜ã¦ã„ã¾ã™ãŒã€ç®¡ç†è€…ãŒä»–ã®æƒ…å ±ã¨ç…§ã‚‰ã—åˆã‚ã›ã‚‹ã“ã¨ã§ã€å®Ÿéš›ã®ä½ç½®ã‚’ç‰¹å®šã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>
                <p style="padding: 16px; background: #e8f5e9; border-left: 4px solid var(--primary-color); border-radius: var(--radius-sm); color: #2e7d32; font-weight: bold;">
                    âœ… ç®¡ç†è€…ã«ã‚ˆã‚‹ä½ç½®æƒ…å ±ã®ä½¿ç”¨ã«ã¤ã„ã¦<br>
                    ç®¡ç†è€…ã¯ã€ä½ç½®æƒ…å ±ã‚’ç§åˆ©ç§æ¬²ã®ãŸã‚ã«ä½¿ç”¨ã™ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä½ç½®æƒ…å ±ã¯ã€ã‚ãã¾ã§æœ¬ã‚¢ãƒ—ãƒªã®æ­£å¸¸ãªå‹•ä½œã‚’ç¶­æŒã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒäºˆå®šã®ç›®çš„åœ°ã«åˆ°ç€ã—ãŸã‹ã‚’åˆ¤å®šã™ã‚‹ç›®çš„ã§ã®ã¿ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
                </p>
                
                <h3>3. ä½ç½®æƒ…å ±ã®åˆ©ç”¨ç›®çš„</h3>
                <ul style="margin-bottom: 15px; padding-left: 20px;">
                    <li>äºˆå®šã®ç›®çš„åœ°ã¸ã®åˆ°ç€åˆ¤å®š</li>
                    <li>ã‚·ã‚¹ãƒ†ãƒ ã®ç®¡ç†ãƒ»é‹å–¶</li>
                    <li>çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®ä½œæˆï¼ˆå€‹äººã‚’ç‰¹å®šã§ããªã„å½¢ã§ï¼‰</li>
                </ul>
                
                <h3>4. åŒæ„ã«ã¤ã„ã¦</h3>
                <p>æœ¬ã‚¢ãƒ—ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ä¸Šè¨˜ã®ä½ç½®æƒ…å ±ã®å–ã‚Šæ‰±ã„ã«ã¤ã„ã¦åŒæ„ã—ã¦ã„ãŸã ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚åŒæ„ã„ãŸã ã‘ãªã„å ´åˆã€æœ¬ã‚¢ãƒ—ãƒªã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã›ã‚“ã€‚</p>
                
                <p style="margin-top: 20px; padding: 16px; background: #fff3cd; border-left: 4px solid var(--warning-color); border-radius: var(--radius-sm); color: #856404;">
                    <strong>âš ï¸ æ³¨æ„äº‹é …</strong><br>
                    ä½ç½®æƒ…å ±ã®æä¾›ã¯ä»»æ„ã§ã™ã€‚ãŸã ã—ã€ä½ç½®æƒ…å ±ã‚’æä¾›ã„ãŸã ã‘ãªã„å ´åˆã€æœ¬ã‚¢ãƒ—ãƒªã®ä¸»è¦æ©Ÿèƒ½ï¼ˆäºˆå®šã®åˆ°ç€åˆ¤å®šï¼‰ã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã›ã‚“ã€‚
                </p>
            </div>
            <div class="consent-buttons">
                <button id="consentRejectBtn">åŒæ„ã—ãªã„</button>
                <button id="consentAcceptBtn">åŒæ„ã™ã‚‹</button>
            </div>
        </div>
    </div>
    <style>
        #locationConsentModal {
            height: 100%;
            height: 100vh;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
        }
        #locationConsentModalContent {
            margin-bottom: 200px;
            margin-top: 20px;
        }
        #locationConsentText {
            max-height: none !important;
            overflow-y: visible !important;
            overflow-x: hidden !important;
        }
        @media (max-width: 480px) {
            #locationConsentModalContent {
                margin: 10px auto !important;
                padding: 20px !important;
                padding-bottom: 300px !important;
                max-width: 95% !important;
                margin-bottom: 150px !important;
            }
            #locationConsentModal {
                height: 100vh;
                height: -webkit-fill-available;
            }
        }
    </style>

    <script>
        function isSessionStorageAvailable() {
            try {
                const testKey = '__session_test__';
                sessionStorage.setItem(testKey, '1');
                sessionStorage.removeItem(testKey);
                return true;
            } catch (error) {
                console.error('sessionStorageãŒåˆ©ç”¨ã§ãã¾ã›ã‚“:', error);
                return false;
            }
        }

        function alertSessionStorageIssue() {
            alert(
                'ãƒ–ãƒ©ã‚¦ã‚¶ã®sessionStorageã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ãŸã‚ã€Googleãƒ­ã‚°ã‚¤ãƒ³ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã€‚\n\n' +
                'æ¬¡ã®å¯¾å‡¦ã‚’è©¦ã—ã¦ãã ã•ã„ï¼š\n' +
                '1. Safari/Chromeã‚’é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§é–‹ãï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ/ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ä¸å¯ï¼‰\n' +
                '2. LINEãªã©ã®ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ãªãã€Safari/Chromeæœ¬ä½“ã§é–‹ã\n' +
                '3. ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã€Œã‚µã‚¤ãƒˆè¶Šãˆãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚’è¨±å¯ã€ã€ŒCookieã‚’è¨±å¯ã€ã«ã™ã‚‹'
            );
        }

        // ç®¡ç†è€…é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function showAdminChoiceModal() {
            const modal = document.getElementById('adminChoiceModal');
            if (!modal) return;
            
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            document.documentElement.style.overflow = 'hidden';
            
            // ç®¡ç†ç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
            const adminBtn = document.getElementById('goToAdminDashboardBtn');
            if (adminBtn) {
                adminBtn.onclick = function() {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                    document.documentElement.style.overflow = '';
                    window.location.href = 'admin-dashboard.html';
                };
            }
            
            // äºˆå®šè¨­å®šç”»é¢ãƒœã‚¿ãƒ³
            const calendarBtn = document.getElementById('goToCalendarBtn');
            if (calendarBtn) {
                calendarBtn.onclick = function() {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                    document.documentElement.style.overflow = '';
                    window.location.href = 'calendar.html';
                };
            }
        }
        
        // ä½ç½®æƒ…å ±ã®å–ã‚Šæ‰±ã„ã«é–¢ã™ã‚‹åŒæ„ãƒã‚§ãƒƒã‚¯
        let consentModalInitialized = false;
        function checkLocationConsent() {
            const currentUserId = localStorage.getItem('currentUserId');
            const consentKey = currentUserId ? `locationConsent_${currentUserId}` : 'locationConsent_global';
            const hasConsented = localStorage.getItem(consentKey) === 'true';
            
            if (!hasConsented) {
                const modal = document.getElementById('locationConsentModal');
                if (modal) {
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                    document.documentElement.style.overflow = 'hidden';
                    
                    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®é‡è¤‡ã‚’é˜²ã
                    if (!consentModalInitialized) {
                        const acceptBtn = document.getElementById('consentAcceptBtn');
                        const rejectBtn = document.getElementById('consentRejectBtn');
                        
                        // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰è¿½åŠ 
                        const newAcceptBtn = acceptBtn.cloneNode(true);
                        const newRejectBtn = rejectBtn.cloneNode(true);
                        acceptBtn.parentNode.replaceChild(newAcceptBtn, acceptBtn);
                        rejectBtn.parentNode.replaceChild(newRejectBtn, rejectBtn);
                        
                        // åŒæ„ãƒœã‚¿ãƒ³
                        newAcceptBtn.addEventListener('click', function() {
                            localStorage.setItem(consentKey, 'true');
                            modal.style.display = 'none';
                            document.body.style.overflow = '';
                            document.documentElement.style.overflow = '';
                            // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚’ç¶šè¡Œ
                            const isLoggedIn = localStorage.getItem('isLoggedIn');
                            const userId = localStorage.getItem('currentUserId');
                            if (isLoggedIn === 'true' && userId) {
                                // ãƒœã‚¿ãƒ³ã‚’ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿çŠ¶æ…‹ã«å¤‰æ›´ï¼ˆè‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ãªã„ï¼‰
                                showLoggedInButtons();
                            }
                        });
                        
                        // æ‹’å¦ãƒœã‚¿ãƒ³
                        newRejectBtn.addEventListener('click', function() {
                            alert('ä½ç½®æƒ…å ±ã®å–ã‚Šæ‰±ã„ã«ã¤ã„ã¦åŒæ„ã„ãŸã ã‘ãªã„å ´åˆã€æœ¬ã‚¢ãƒ—ãƒªã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã›ã‚“ã€‚\n\nã‚¢ãƒ—ãƒªã‚’çµ‚äº†ã—ã¾ã™ã€‚');
                            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                            modal.style.display = 'none';
                            document.body.style.overflow = '';
                            document.documentElement.style.overflow = '';
                            // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆåŒæ„ãªã—ã®çŠ¶æ…‹ã‚’ç¶­æŒï¼‰
                            window.location.reload();
                        });
                        
                        consentModalInitialized = true;
                    }
                }
                return false;
            }
            return true;
        }
        
        // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ï¼‰
        function showLoggedInButtons() {
            const loginArea = document.getElementById('loginButtonsArea');
            const loggedInArea = document.getElementById('loggedInButtonsArea');
            if (loginArea) loginArea.style.display = 'none';
            if (loggedInArea) loggedInArea.style.display = 'flex';
        }
        
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ï¼‰
        function showLoginButtons() {
            const loginArea = document.getElementById('loginButtonsArea');
            const loggedInArea = document.getElementById('loggedInButtonsArea');
            if (loginArea) loginArea.style.display = 'flex';
            if (loggedInArea) loggedInArea.style.display = 'none';
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ç™»éŒ²æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
        document.addEventListener('DOMContentLoaded', function() {
            // localStorageãŒä½¿ç”¨å¯èƒ½ã‹ç¢ºèª
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
            } catch (e) {
                console.error('localStorageãŒä½¿ç”¨ã§ãã¾ã›ã‚“:', e);
                alert('localStorageãŒä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚\nã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰/ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤ã™ã‚‹ã‹ã€\nãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§localStorageã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const currentUserId = localStorage.getItem('currentUserId');
            const userAccounts = JSON.parse(localStorage.getItem('userAccounts') || '[]');
            
            console.log('ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯:', {
                isLoggedIn: isLoggedIn,
                currentUserId: currentUserId,
                userAccountsCount: userAccounts.length
            });
            
            // Firebaseèªè¨¼çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
            if (auth) {
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        console.log('Firebaseèªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼:', user.uid);
                        // Firestoreã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
                        db.collection('users').doc(user.uid).get()
                            .then((doc) => {
                                if (doc.exists) {
                                    const userData = doc.data();
                                    localStorage.setItem('currentUserId', user.uid);
                                    localStorage.setItem('isLoggedIn', 'true');
                                    localStorage.setItem('userAccount', JSON.stringify(userData));
                                    
                                    // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã¯ãƒœã‚¿ãƒ³ã‚’å¤‰æ›´ï¼ˆè‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ãªã„ï¼‰
                                    showLoggedInButtons();
                                }
                            });
                    } else {
                        // Firebaseæœªèªè¨¼ã®å ´åˆã€localStorageã‚’ãƒã‚§ãƒƒã‚¯
                        checkLocalStorageLogin();
                    }
                });
            } else {
                // FirebaseãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯localStorageã‚’ãƒã‚§ãƒƒã‚¯
                checkLocalStorageLogin();
            }
            
            function checkLocalStorageLogin() {
                // æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã¯ãƒœã‚¿ãƒ³ã‚’å¤‰æ›´
                if (isLoggedIn === 'true' && currentUserId) {
                    const currentUser = userAccounts.find(acc => acc.id.toString() === currentUserId);
                    if (currentUser) {
                        console.log('ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼:', currentUser);
                        // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã¯ãƒœã‚¿ãƒ³ã‚’å¤‰æ›´
                        showLoggedInButtons();
                        return;
                    } else {
                        console.warn('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ã«
                        localStorage.removeItem('currentUserId');
                        localStorage.removeItem('isLoggedIn');
                        showLoginButtons();
                    }
                } else {
                    console.log('æœªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹');
                    showLoginButtons();
                }
            }
            
            // ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
            setupLogin();
            
            // Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ã‚°ã‚¤ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
            setupGoogleSignIn();
            
            // ã€Œå§‹ã‚ã‚‹ã€ãƒœã‚¿ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
            const startButton = document.getElementById('startButton');
            if (startButton) {
                startButton.addEventListener('click', function() {
                    const userAccount = JSON.parse(localStorage.getItem('userAccount') || '{}');
                    // ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å ´åˆã¯é¸æŠç”»é¢ã‚’è¡¨ç¤º
                    if (userAccount.email === 'uriuri4321@gmail.com') {
                        showAdminChoiceModal();
                    } else {
                        window.location.href = 'calendar.html';
                    }
                });
            }
            
            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.addEventListener('click', function() {
                    if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ\nå†åº¦ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚')) {
                        // Firebaseèªè¨¼ã‹ã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                        if (auth) {
                            auth.signOut().then(() => {
                                console.log('Firebaseã‹ã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
                            }).catch((error) => {
                                console.error('Firebaseãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                            });
                        }
                        
                        // localStorageã‚’ã‚¯ãƒªã‚¢
                        localStorage.removeItem('currentUserId');
                        localStorage.removeItem('isLoggedIn');
                        localStorage.removeItem('userAccount');
                        
                        // ä½ç½®æƒ…å ±ã®åŒæ„ã‚‚ã‚¯ãƒªã‚¢ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                        // localStorage.removeItem('locationConsent_' + currentUserId);
                        
                        alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
                        
                        // ãƒœã‚¿ãƒ³ã‚’ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã«æˆ»ã™
                        showLoginButtons();
                        
                        // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
                        window.location.reload();
                    }
                });
            }
            
            // register.htmlã‹ã‚‰ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚ŒãŸå ´åˆã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è‡ªå‹•å…¥åŠ›
            const loginEmail = localStorage.getItem('loginEmail');
            if (loginEmail) {
                const emailInput = document.getElementById('loginEmail');
                if (emailInput) {
                    emailInput.value = loginEmail;
                    document.getElementById('loginSection').style.display = 'block';
                    document.getElementById('registerLink').style.display = 'none';
                    document.getElementById('loginPassword').focus();
                }
                localStorage.removeItem('loginEmail');
            }
        });
        
        // ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        function setupLogin() {
            const loginForm = document.getElementById('loginForm');
            const loginSection = document.getElementById('loginSection');
            const registerLink = document.getElementById('registerLink');
            const showRegisterLink = document.getElementById('showRegisterLink');
            
            if (!loginForm || !loginSection) return;
            
            // ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                
                if (!email || !password) {
                    alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                // Firebase Authenticationã§ãƒ­ã‚°ã‚¤ãƒ³
                if (auth && db) {
                    auth.signInWithEmailAndPassword(email, password)
                        .then((userCredential) => {
                            const user = userCredential.user;
                            console.log('Firebaseãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', user.uid);
                            
                            // Firestoreã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
                            return db.collection('users').doc(user.uid).get();
                        })
                        .then((doc) => {
                            if (doc.exists) {
                                const userData = doc.data();
                                
                                // æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ã‚’æ›´æ–°
                                db.collection('users').doc(userData.id).update({
                                    lastLoginAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                
                                // localStorageã«ã‚‚ä¿å­˜
                                localStorage.setItem('currentUserId', userData.id);
                                localStorage.setItem('isLoggedIn', 'true');
                                localStorage.setItem('userAccount', JSON.stringify(userData));
                                
                                alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼');
                                
                                // ãƒœã‚¿ãƒ³ã‚’ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿çŠ¶æ…‹ã«å¤‰æ›´
                                showLoggedInButtons();
                                
                                // ä½ç½®æƒ…å ±ã®åŒæ„ã‚’ãƒã‚§ãƒƒã‚¯
                                const consentKey = `locationConsent_${userData.id}`;
                                if (localStorage.getItem(consentKey) !== 'true') {
                                    // åŒæ„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                                    checkLocationConsent();
                                    return; // åŒæ„ã™ã‚‹ã¾ã§å¾…æ©Ÿ
                                }
                                
                                // ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å ´åˆã¯é¸æŠç”»é¢ã‚’è¡¨ç¤ºï¼ˆè‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ãªã„ï¼‰
                                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œå§‹ã‚ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«è¡¨ç¤ºã•ã‚Œã‚‹
                            } else {
                                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                            }
                        })
                        .catch((error) => {
                            console.error('Firebaseãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                            let errorMessage = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                            if (error.code === 'auth/user-not-found') {
                                errorMessage = 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
                            } else if (error.code === 'auth/wrong-password') {
                                errorMessage = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚';
                            } else if (error.code === 'auth/invalid-email') {
                                errorMessage = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚';
                            }
                            alert(errorMessage);
                        });
                } else {
                    // FirebaseãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯localStorageã®ã¿ä½¿ç”¨
                    const userAccounts = JSON.parse(localStorage.getItem('userAccounts') || '[]');
                    const user = userAccounts.find(acc => acc.email === email && acc.password === password);
                    
                    if (user) {
                        localStorage.setItem('currentUserId', user.id.toString());
                        localStorage.setItem('isLoggedIn', 'true');
                        localStorage.setItem('userAccount', JSON.stringify(user));
                        
                        user.lastLoginAt = new Date().toISOString();
                        const userIndex = userAccounts.findIndex(acc => acc.id === user.id);
                        if (userIndex !== -1) {
                            userAccounts[userIndex] = user;
                            localStorage.setItem('userAccounts', JSON.stringify(userAccounts));
                        }
                        
                        alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼');
                        
                        // ãƒœã‚¿ãƒ³ã‚’ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿çŠ¶æ…‹ã«å¤‰æ›´
                        showLoggedInButtons();
                        
                        // ä½ç½®æƒ…å ±ã®åŒæ„ã‚’ãƒã‚§ãƒƒã‚¯
                        const consentKey = `locationConsent_${user.uid}`;
                        if (localStorage.getItem(consentKey) !== 'true') {
                            // åŒæ„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                            checkLocationConsent();
                            return; // åŒæ„ã™ã‚‹ã¾ã§å¾…æ©Ÿ
                        }
                        
                        // ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å ´åˆã¯é¸æŠç”»é¢ã‚’è¡¨ç¤ºï¼ˆè‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ãªã„ï¼‰
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œå§‹ã‚ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«è¡¨ç¤ºã•ã‚Œã‚‹
                    } else {
                        alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚');
                    }
                }
            });
            
            // ã€Œã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²ã¯ã“ã¡ã‚‰ã€ãƒªãƒ³ã‚¯ã®ã‚¯ãƒªãƒƒã‚¯
            if (showRegisterLink) {
                showRegisterLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    loginSection.style.display = 'none';
                    if (registerLink) registerLink.style.display = 'block';
                    if (showLoginButton) showLoginButton.style.display = 'block';
                });
            }
            
            // ã€Œãƒ­ã‚°ã‚¤ãƒ³ã€ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯
            const showLoginButton = document.getElementById('showLoginButton');
            if (showLoginButton) {
                showLoginButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    loginSection.style.display = 'block';
                    if (registerLink) registerLink.style.display = 'none';
                    if (showLoginButton) showLoginButton.style.display = 'none';
                    document.getElementById('loginEmail').focus();
                });
            }
            
            // ãƒ­ã‚°ã‚¤ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
            const closeLoginSection = document.getElementById('closeLoginSection');
            if (closeLoginSection) {
                closeLoginSection.addEventListener('click', function(e) {
                    e.preventDefault();
                    loginSection.style.display = 'none';
                    if (registerLink) registerLink.style.display = 'block';
                    if (showLoginButton) showLoginButton.style.display = 'block';
                });
            }
        }
        
        // Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ã‚°ã‚¤ãƒ³ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        function setupGoogleSignIn() {
            if (!auth || !db) return;
            
            // Google Sign-Inãƒœã‚¿ãƒ³ã®è¨­å®š
            const googleSignInButton = document.getElementById('googleSignInButton');
            if (!googleSignInButton) return;
            
            // Googleèªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®è¨­å®š
            const provider = new firebase.auth.GoogleAuthProvider();
            
            // Google Sign-Inãƒœã‚¿ãƒ³ã‚’ä½œæˆ
            googleSignInButton.innerHTML = `
                <button id="googleLoginBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³
                </button>
            `;
            
            // Googleãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('googleLoginBtn').addEventListener('click', function() {
                if (!isSessionStorageAvailable()) {
                    alertSessionStorageIssue();
                    return;
                }

                // ã¾ãšãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§è©¦è¡Œ
                auth.signInWithPopup(provider)
                    .then((result) => {
                        const user = result.user;
                        console.log('Googleãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', user.uid);
                        
                        // Firestoreã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜ï¼ˆåˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ï¼‰
                        const userRef = db.collection('users').doc(user.uid);
                        return userRef.get().then((doc) => {
                            if (!doc.exists) {
                                // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆ
                                const userData = {
                                    id: user.uid,
                                    username: user.displayName || 'Googleãƒ¦ãƒ¼ã‚¶ãƒ¼',
                                    email: user.email,
                                    registeredAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    provider: 'google'
                                };
                                return userRef.set(userData).then(() => userData);
                            } else {
                                // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã€æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ã‚’æ›´æ–°
                                const userData = doc.data();
                                return userRef.update({
                                    lastLoginAt: firebase.firestore.FieldValue.serverTimestamp()
                                }).then(() => userData);
                            }
                        })
                        .then((userData) => {
                            // localStorageã«ã‚‚ä¿å­˜
                            localStorage.setItem('currentUserId', user.uid);
                            localStorage.setItem('isLoggedIn', 'true');
                            localStorage.setItem('userAccount', JSON.stringify(userData));
                            
                            alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼');
                            
                            // ãƒœã‚¿ãƒ³ã‚’ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿çŠ¶æ…‹ã«å¤‰æ›´
                            showLoggedInButtons();
                            
                            // ä½ç½®æƒ…å ±ã®åŒæ„ã‚’ãƒã‚§ãƒƒã‚¯
                            const consentKey = `locationConsent_${user.uid}`;
                            if (localStorage.getItem(consentKey) !== 'true') {
                                // åŒæ„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                                checkLocationConsent();
                                return; // åŒæ„ã™ã‚‹ã¾ã§å¾…æ©Ÿ
                            }
                            
                            // ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å ´åˆã¯é¸æŠç”»é¢ã‚’è¡¨ç¤ºï¼ˆè‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ãªã„ï¼‰
                            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œå§‹ã‚ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«è¡¨ç¤ºã•ã‚Œã‚‹
                        });
                    })
                    .catch((error) => {
                        console.error('Googleãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼‰:', error);
                        console.error('ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰:', error.code);
                        console.error('ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', error.message);
                        
                        // ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆWebViewï¼‰ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã®å ´åˆ
                        if (error.code === 'auth/unauthorized-domain' || 
                            error.message.includes('disallowed_useragent') ||
                            error.message.includes('å®‰å…¨ãªãƒ–ãƒ©ã‚¦ã‚¶')) {
                            let errorMessage = 'âš ï¸ Googleãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼\n\n';
                            errorMessage += 'ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆLINEã€Twitterã€Facebookå†…ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼‰ã‹ã‚‰ã¯\n';
                            errorMessage += 'Googleãƒ­ã‚°ã‚¤ãƒ³ãŒä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚\n\n';
                            errorMessage += 'ã€è§£æ±ºæ–¹æ³•ã€‘\n';
                            errorMessage += '1. é€šå¸¸ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆSafariã€Chromeï¼‰ã§ã“ã®ã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦ãã ã•ã„\n';
                            errorMessage += '2. ã¾ãŸã¯ã€URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„\n\n';
                            errorMessage += 'è©³ç´°ã¯ã€ŒGoogleãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼403è§£æ±ºæ‰‹é †.mdã€ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚';
                            alert(errorMessage);
                            return;
                        }
                        
                        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã‚„auth/popup-blockedã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ–¹å¼ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                        if (error.code === 'auth/popup-blocked' || error.code === 'auth/popup-closed-by-user') {
                            console.log('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸãŸã‚ã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ–¹å¼ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™');
                            auth.signInWithRedirect(provider)
                                .then(() => {
                                    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãŒæˆåŠŸã—ãŸå ´åˆã€ãƒšãƒ¼ã‚¸ãŒãƒªãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹
                                })
                                .catch((redirectError) => {
                                    console.error('Googleãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰:', redirectError);
                                    let errorMessage = 'Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã®ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n';
                                    if (redirectError.code === 'auth/unauthorized-domain') {
                                        const currentHost = window.location.host;
                                        errorMessage += 'ã€ç¾åœ¨ã®URLã€‘\n' + currentHost + '\n\n';
                                        errorMessage += 'ã€è§£æ±ºæ–¹æ³•ã€‘\n';
                                        errorMessage += '1. Firebase Console (https://console.firebase.google.com/) ã«ã‚¢ã‚¯ã‚»ã‚¹\n';
                                        errorMessage += '2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œikerukane-appã€ã‚’é¸æŠ\n';
                                        errorMessage += '3. Authentication > Sign-in method ã‚’é–‹ã\n';
                                        errorMessage += '4. ã€Œæ‰¿èªæ¸ˆã¿ãƒ‰ãƒ¡ã‚¤ãƒ³ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ä»¥ä¸‹ã‚’è¿½åŠ ï¼š\n';
                                        errorMessage += '   - localhost\n';
                                        errorMessage += '   - 127.0.0.1\n';
                                        if (currentHost.includes(':')) {
                                            errorMessage += '   - ' + currentHost + '\n';
                                        }
                                        errorMessage += '\nè©³ç´°ã¯ã€ŒGoogleãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼403è§£æ±ºæ‰‹é †.mdã€ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚';
                                    } else if (redirectError.code === 'auth/operation-not-allowed') {
                                        errorMessage += 'Googleèªè¨¼ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã›ã‚“ã€‚\n\n';
                                        errorMessage += 'ã€è§£æ±ºæ–¹æ³•ã€‘\n';
                                        errorMessage += '1. Firebase Console (https://console.firebase.google.com/) ã«ã‚¢ã‚¯ã‚»ã‚¹\n';
                                        errorMessage += '2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œikerukane-appã€ã‚’é¸æŠ\n';
                                        errorMessage += '3. Authentication > Sign-in method ã‚’é–‹ã\n';
                                        errorMessage += '4. ã€ŒGoogleã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æœ‰åŠ¹åŒ–\n';
                                    } else {
                                        errorMessage += 'ã‚¨ãƒ©ãƒ¼: ' + redirectError.message;
                                    }
                                    alert(errorMessage);
                                });
                        } else {
                            // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
                            let errorMessage = 'Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã®ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n';
                            if (error.code === 'auth/unauthorized-domain') {
                                const currentHost = window.location.host;
                                errorMessage += 'ã€ç¾åœ¨ã®URLã€‘\n' + currentHost + '\n\n';
                                errorMessage += 'ã€è§£æ±ºæ–¹æ³•ã€‘\n';
                                errorMessage += '1. Firebase Console (https://console.firebase.google.com/) ã«ã‚¢ã‚¯ã‚»ã‚¹\n';
                                errorMessage += '2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œikerukane-appã€ã‚’é¸æŠ\n';
                                errorMessage += '3. Authentication > Sign-in method ã‚’é–‹ã\n';
                                errorMessage += '4. ã€Œæ‰¿èªæ¸ˆã¿ãƒ‰ãƒ¡ã‚¤ãƒ³ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ä»¥ä¸‹ã‚’è¿½åŠ ï¼š\n';
                                errorMessage += '   - localhost\n';
                                errorMessage += '   - 127.0.0.1\n';
                                if (currentHost.includes(':')) {
                                    errorMessage += '   - ' + currentHost + '\n';
                                }
                                errorMessage += '\nè©³ç´°ã¯ã€ŒGoogleãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼403è§£æ±ºæ‰‹é †.mdã€ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚';
                            } else if (error.code === 'auth/operation-not-allowed') {
                                errorMessage += 'Googleèªè¨¼ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã›ã‚“ã€‚\n\n';
                                errorMessage += 'ã€è§£æ±ºæ–¹æ³•ã€‘\n';
                                errorMessage += '1. Firebase Console (https://console.firebase.google.com/) ã«ã‚¢ã‚¯ã‚»ã‚¹\n';
                                errorMessage += '2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œikerukane-appã€ã‚’é¸æŠ\n';
                                errorMessage += '3. Authentication > Sign-in method ã‚’é–‹ã\n';
                                errorMessage += '4. ã€ŒGoogleã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æœ‰åŠ¹åŒ–\n';
                            } else if (error.code === 'auth/popup-closed-by-user') {
                                errorMessage += 'ãƒ­ã‚°ã‚¤ãƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
                            } else {
                                errorMessage += 'ã‚¨ãƒ©ãƒ¼: ' + error.message + '\nã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: ' + error.code;
                            }
                            alert(errorMessage);
                        }
                    });
            });
            
            // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¾Œã®èªè¨¼çµæœã‚’å‡¦ç†
            auth.getRedirectResult()
                .then((result) => {
                    if (result.user) {
                        const user = result.user;
                        console.log('Googleãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰:', user.uid);
                        
                        // Firestoreã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜ï¼ˆåˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ï¼‰
                        const userRef = db.collection('users').doc(user.uid);
                        return userRef.get().then((doc) => {
                            if (!doc.exists) {
                                // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆ
                                const userData = {
                                    id: user.uid,
                                    username: user.displayName || 'Googleãƒ¦ãƒ¼ã‚¶ãƒ¼',
                                    email: user.email,
                                    registeredAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    lastLoginAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    provider: 'google'
                                };
                                return userRef.set(userData).then(() => userData);
                            } else {
                                // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆã€æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ã‚’æ›´æ–°
                                const userData = doc.data();
                                return userRef.update({
                                    lastLoginAt: firebase.firestore.FieldValue.serverTimestamp()
                                }).then(() => userData);
                            }
                        })
                        .then((userData) => {
                            // localStorageã«ã‚‚ä¿å­˜
                            localStorage.setItem('currentUserId', user.uid);
                            localStorage.setItem('isLoggedIn', 'true');
                            localStorage.setItem('userAccount', JSON.stringify(userData));
                            
                            alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼');
                            
                            // ãƒœã‚¿ãƒ³ã‚’ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿çŠ¶æ…‹ã«å¤‰æ›´
                            showLoggedInButtons();
                            
                            // ä½ç½®æƒ…å ±ã®åŒæ„ã‚’ãƒã‚§ãƒƒã‚¯
                            const consentKey = `locationConsent_${user.uid}`;
                            if (localStorage.getItem(consentKey) !== 'true') {
                                // åŒæ„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                                checkLocationConsent();
                                return; // åŒæ„ã™ã‚‹ã¾ã§å¾…æ©Ÿ
                            }
                            
                            // ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å ´åˆã¯é¸æŠç”»é¢ã‚’è¡¨ç¤ºï¼ˆè‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ãªã„ï¼‰
                            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œå§‹ã‚ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«è¡¨ç¤ºã•ã‚Œã‚‹
                        });
                    }
                })
                .catch((error) => {
                    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆçµæœãŒãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–ï¼ˆé€šå¸¸ã®çŠ¶æ…‹ï¼‰
                    if (error.code !== 'auth/credential-already-in-use' && error.code !== 'auth/email-already-in-use') {
                        console.error('ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆçµæœã®å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                    }
                });
        }
    </script>
</body>