# イケルカネ - お金の抑止力で遅刻をさせない
## 位置情報を活用した遅刻防止アプリケーションの開発

---

## 目次

要旨
1. はじめに
   1.1. 開発背景
   1.2. 開発目的
2. 設計・実装
   2.1. 要件定義
   2.2. ユースケース
   2.3. 使用言語・ライブラリ
   2.4. システム構成
3. 評価
   3.1. 動作確認
   3.2. 性能評価
   3.3. ユーザテスト結果
4. 考察
5. まとめ
参考文献
付録A　主要な機能一覧
付録B　システムの技術仕様

---

## 要旨

　本研究では，経済的インセンティブと位置情報技術を組み合わせた新しい遅刻防止アプリケーション「イケルカネ」を開発した。本システムは，「お金の抑止力で遅刻をさせない」というコンセプトのもと，位置情報技術を活用して自動的に到着を判定し，遅刻した場合には設定した金額が課金される仕組みを実装したWebアプリケーションである。ユーザーは予定を登録する際に，目的地と期日，そして遅刻した場合の課金額を設定する。予定の期日になった時点で，システムが自動的に現在位置を取得し，目的地から100メートル以内にいるかどうかを判定する。目的地に到着していれば課金は発生せず，到着していなければ設定した金額が課金される。本システムは，HTML5，CSS3，JavaScript（Vanilla JS）を用いてフロントエンドを実装し，Firebase AuthenticationとFirebase Firestoreを用いてユーザー認証とデータ管理を実現した。また，Google Maps JavaScript APIを活用して地図表示と位置情報の取得を行い，Haversine formulaを用いて正確な距離計算を実装した。さらに，定期予定機能により，毎週同じ時間・同じ場所で行われる予定を自動的に設定することができる。本システムは，実用的なWebアプリケーションとして実装され，実際に使用可能な状態である。今後は，実際の決済機能の実装や，ユーザー行動データの分析を通じて，経済的インセンティブが遅刻防止にどの程度効果があるかを検証していく予定である。

---

## 1. はじめに

### 1.1. 開発背景

　現代社会において，時間を守ることは信頼関係を構築する上で重要な要素である。しかし，約束の時間に遅れることは，個人の自己管理能力や信頼性に影響を与える問題として存在している。特に，ビジネスシーンや学業において，時間を守ることは基本的なマナーとして求められるが，自己管理が難しい場面や，緊急事態が発生した場合など，様々な要因により遅刻が発生することがある。

　従来の遅刻防止のアプローチとしては，アラーム機能やカレンダーアプリケーションなどが存在するが，これらは主に「意識改革」に依存しており，実際の行動変容を促すには不十分な場合がある。また，これらのアプリケーションは，ユーザーが手動で到着を報告する必要があるため，正確性に欠ける場合がある。

　本研究では，経済的インセンティブを活用した新しい遅刻防止アプローチを提案する。具体的には，遅刻すると設定した金額が課金される仕組みにより，遅刻に対する経済的コストを明確化し，位置情報技術を活用して自動的に到着を判定することで，より効果的な遅刻防止を実現することを目的とする。

### 1.2. 開発目的

　本研究の目的は，経済的インセンティブと位置情報技術を組み合わせた新しい遅刻防止アプリケーション「イケルカネ」を開発することである。本システムは，以下の3つの要素を組み合わせることで，より効果的な遅刻防止を実現する。

　第一に，経済的インセンティブを活用する。遅刻すると設定した金額が課金される仕組みにより，遅刻に対する経済的コストを明確化し，ユーザーの行動変容を促す。

　第二に，位置情報技術を活用する。リアルタイムで現在位置を取得し，目的地までの距離を自動計算することで，到着判定を自動化し，ユーザーの手動操作を最小限に抑える。

　第三に，自動検知システムを実装する。設定した日時になった時点で，自動的に到着判定を実行し，公平で正確な判定を実現する。

　本システムは，実用的なWebアプリケーションとして実装し，実際に使用可能な状態にすることを目指す。また，将来的には，実際の決済機能の実装や，ユーザー行動データの分析を通じて，経済的インセンティブが遅刻防止にどの程度効果があるかを検証することを目的とする。

---

## 2. 設計・実装

### 2.1. 要件定義

#### 2.1.1. 機能要件

本システムは，以下の機能要件を満たす必要がある。

**ユーザー認証機能**
- メールアドレスとパスワードによる認証
- Googleアカウントによる認証
- ログイン状態の保持
- ログアウト機能

**予定管理機能**
- 予定の作成，編集，削除
- 予定の一覧表示
- 予定の詳細表示
- 定期予定の設定（毎週同じ時間・同じ場所で自動設定）

**目的地設定機能**
- 地図上で目的地を選択
- 場所の検索機能（Google Places API）
- 課金額の設定（100円以上）

**位置情報追跡機能**
- リアルタイムで現在位置を取得
- 目的地までの距離を計算
- 残り時間と距離を表示
- 到着予測時間の表示

**到着判定機能**
- 設定した日時になった時点で，自動的に到着判定を実行
- 目的地から100メートル以内にいるかどうかを判定
- 到着成功の場合は課金なし，遅刻の場合は課金額を記録

**予定履歴機能**
- 過去に設定した予定を自動的に履歴として保存
- 直近10件の予定履歴を表示
- 履歴から予定を再利用

**統計・管理機能**
- 個人の遅刻履歴を確認
- 管理者ダッシュボードで全体統計を確認

#### 2.1.2. 非機能要件

**パフォーマンス要件**
- 位置情報の取得は5秒以内に完了すること
- 距離計算は1秒以内に完了すること
- 画面遷移は1秒以内に完了すること

**可用性要件**
- オフライン時でも基本的な機能が動作すること
- ネットワーク接続が不安定な環境でも動作すること

**セキュリティ要件**
- ユーザーは自分のデータのみにアクセスできること
- 管理者ユーザーのみが全ユーザーのデータにアクセスできること
- 位置情報は予定の到着判定にのみ使用されること

**ユーザビリティ要件**
- スマートフォンとPCの両方で最適な表示を実現すること
- 直感的なUI/UX設計であること
- リアルタイムでフィードバックを提供すること

### 2.2. ユースケース

本システムの主なユースケースを以下に示す。

**UC1: ユーザー登録・ログイン**
1. ユーザーがアプリにアクセスする
2. メールアドレスとパスワード，またはGoogleアカウントでログインする
3. ログインに成功すると，予定管理画面が表示される

**UC2: 予定の作成**
1. ユーザーが「予定設定」ボタンをクリックする
2. 予定タイトルと期日を入力する
3. 「定期予定」チェックボックスにチェックを入れる（任意）
4. 「設定」ボタンをクリックする
5. 予定が作成され，目的地設定画面に遷移する

**UC3: 目的地の設定**
1. ユーザーが地図上で目的地を選択する（または検索ボックスで場所を検索する）
2. 課金額を入力する（100円以上）
3. 「決定」ボタンをクリックする
4. 目的地と課金額が保存され，到着判定画面に遷移する

**UC4: 到着判定**
1. 予定の期日が近づくと，システムが自動的に位置情報の取得を開始する
2. 設定した日時になった時点で，システムが自動的に到着判定を実行する
3. 目的地から100メートル以内にいる場合は「クリア」，そうでない場合は「時間切れ」として判定される
4. 判定結果がFirestoreとlocalStorageに保存される

**UC5: 定期予定の自動設定**
1. ユーザーが「定期予定」チェックボックスにチェックを入れて予定を作成する
2. 今週の予定が終了（クリアまたは時間切れ）した時点で，次週の予定が自動的に作成される
3. 次週の予定は，今週の予定と同じ時刻・同じ場所で設定される

**UC6: 予定履歴の再利用**
1. ユーザーが「予定履歴」タブをクリックする
2. 直近10件の予定履歴が表示される
3. ユーザーが履歴アイテムをクリックする
4. 予定入力フォームにタイトルと位置情報が自動入力される
5. ユーザーが期日を入力して予定を作成する

### 2.3. 使用言語・ライブラリ

#### 2.3.1. フロントエンド

本システムのフロントエンドは，以下の技術を使用して実装した。

**HTML5**
- セマンティックなHTML構造を実装
- フォーム要素，地図表示用のdiv要素などを使用

**CSS3**
- レスポンシブデザインを実装
- CSS変数を使用してカラーパレットを管理
- メディアクエリを使用してスマートフォンとPCの両方に対応
- アニメーション効果を実装

**JavaScript（Vanilla JS）**
- フレームワークを使用せず，純粋なJavaScriptで実装
- ES6+の機能（アロー関数，テンプレートリテラル，async/awaitなど）を使用
- DOM操作，イベントハンドリング，非同期処理を実装

#### 2.3.2. バックエンド・データベース

**Firebase Authentication**
- ユーザー認証システムを実装
- メール/パスワード認証とGoogle Sign-Inの両方に対応
- セキュアな認証トークンの管理

**Firebase Firestore**
- NoSQLクラウドデータベースを使用
- 予定データ，位置情報履歴，課金情報を保存
- 複数デバイス間でのデータ同期を実現
- リアルタイムデータ更新に対応
- セキュリティルールにより，ユーザーごとのデータ分離を実現

#### 2.3.3. 外部API

**Google Maps JavaScript API**
- 地図表示機能を実装
- 位置検索機能（Google Places API）を実装
- 距離計算機能を実装

#### 2.3.4. その他の技術

**localStorage**
- オフライン時のキャッシュとして使用
- ユーザーごとのデータを保存
- 既存データのFirestoreへの自動移行機能を実装

**Web Geolocation API**
- 位置情報の取得機能を実装
- `navigator.geolocation.watchPosition()`を使用して継続的に位置情報を取得
- エラーハンドリングとリトライ機能を実装

### 2.4. システム構成

#### 2.4.1. 全体アーキテクチャ

本システムは，サーバーレスアーキテクチャを採用している。具体的には，以下の特徴を持つ。

- **クライアントサイド処理**: 位置情報の取得，距離計算，UI更新などの処理は，すべてクライアント側（ブラウザ）で実行される
- **クラウドデータベース**: Firestoreを使用して，予定データやユーザー情報をクラウド上に保存
- **オフライン対応**: localStorageをキャッシュとして使用し，オフライン時でも基本的な機能が動作する

#### 2.4.2. 画面遷移

本システムの画面遷移は以下の通りである。

1. **index.html（タイトル画面）**
   - アプリのタイトルとキャッチコピーを表示
   - ログイン/アカウント登録ボタンを表示
   - 既にログインしている場合は，「始める」ボタンと「ログアウト」ボタンを表示

2. **register.html（アカウント登録画面）**
   - メールアドレスとパスワードによる登録
   - Googleアカウントによる登録

3. **calendar.html（予定管理画面）**
   - 予定の一覧表示
   - 予定の作成，編集，削除
   - 予定履歴の表示
   - 使い方の説明

4. **map.html（目的地設定画面）**
   - 地図上で目的地を選択
   - 場所の検索
   - 課金額の設定

5. **check.html（到着判定画面）**
   - リアルタイムで現在位置を表示
   - 目的地までの距離を表示
   - 残り時間を表示
   - 到着判定の結果を表示

6. **admin-dashboard.html（管理者ダッシュボード）**
   - 全ユーザーの統計情報を表示
   - 遅刻率，課金額の合計などを表示

#### 2.4.3. データベース設計

Firestoreのデータベース設計は以下の通りである。

**usersコレクション**
- ユーザーID（ドキュメントID）
- メールアドレス
- ユーザー名
- 作成日時
- 更新日時

**eventsコレクション**
- イベントID（ドキュメントID）
- ユーザーID
- 予定タイトル
- 開始日時
- 終了日時
- ステータス（active，completed，failed）
- 緯度
- 経度
- 課金額
- 定期予定フラグ
- 作成日時
- 更新日時
- 完了日時（完了時）

**penaltiesコレクション**
- ペナルティID（ドキュメントID）
- ユーザーID
- イベントID
- 課金額
- イベントタイトル
- イベント期日
- 作成日時
- ステータス（failed）

**users/{userId}/paymentMethodsサブコレクション**
- 支払方法ID（ドキュメントID）
- 支払方法タイプ（creditCard，paypay）
- 支払方法情報
- 更新日時

#### 2.4.4. 位置情報の取得と処理

位置情報の取得には，Web Geolocation APIを使用している。具体的な実装は以下の通りである。

```javascript
// 継続的な位置情報の監視
navigator.geolocation.watchPosition(
    function(position) {
        const currentLat = position.coords.latitude;
        const currentLng = position.coords.longitude;
        // 位置情報の更新処理
    },
    function(error) {
        // エラーハンドリング
    },
    {
        enableHighAccuracy: true,
        timeout: 30000,
        maximumAge: 5000
    }
);
```

距離計算には，Haversine formula（球面距離計算）を使用している。このアルゴリズムは，地球を球面として扱い，緯度・経度から正確な距離を計算する。

```javascript
// Haversine formulaによる距離計算（km単位）
const R = Math.PI / 180; // 度からラジアンへの変換係数
const distance = 6371 * Math.acos(
    Math.cos(targetLat*R) * Math.cos(nowLat*R) * Math.cos(nowLng*R - targetLng*R) +
    Math.sin(targetLat*R) * Math.sin(nowLat*R)
);
```

ここで，`6371`は地球の半径（km）である。

#### 2.4.5. 到着判定の実装

到着判定は，設定した日時になった時点で一度だけ実行される。判定の流れは以下の通りである。

1. **時刻チェック**: `updateTime()`関数が1秒ごとに実行され，設定した日時になったかどうかをチェック
2. **位置情報取得**: 設定した日時になった時点で，最新の位置情報を取得
3. **距離計算**: 取得した位置情報と目的地の距離を，Haversine formulaで計算
4. **判定実行**: 距離が100メートル以内であれば「クリア」，そうでなければ「時間切れ」として判定
5. **結果記録**: 判定結果をFirestoreとlocalStorageに保存

この実装により，設定した日時になった瞬間の位置情報で判定が行われるため，より公平で正確な判定が可能となる。

#### 2.4.6. 定期予定機能の実装

定期予定機能は，毎週同じ時間・同じ場所で行われる予定（例：講義）を自動的に設定する機能である。実装のポイントは以下の通りである。

- **予定終了時の自動作成**: 今週の予定が終了（クリアまたは時間切れ）した時点で，次週の予定が自動的に作成される
- **重複防止**: 予定終了時に次週の予定を作成する際，既に作成済みの場合は重複作成を防止する
- **時間の正確性**: 次週の予定は，今週の予定と同じ時刻（例：15時）で作成されるため，時間のずれが発生しない

---

## 3. 評価

### 3.1. 動作確認

本システムの主要な機能について，動作確認を行った。以下に結果を示す。

**ユーザー認証機能**
- メールアドレスとパスワードによる認証が正常に動作することを確認
- Googleアカウントによる認証が正常に動作することを確認
- ログイン状態が正しく保持されることを確認
- ログアウト機能が正常に動作することを確認

**予定管理機能**
- 予定の作成，編集，削除が正常に動作することを確認
- 予定の一覧表示が正常に動作することを確認
- 定期予定の設定が正常に動作することを確認
- 予定終了時に次週の予定が自動的に作成されることを確認

**目的地設定機能**
- 地図上で目的地を選択できることを確認
- 場所の検索機能が正常に動作することを確認
- 課金額の設定が正常に動作することを確認

**位置情報追跡機能**
- リアルタイムで現在位置を取得できることを確認
- 目的地までの距離を正確に計算できることを確認
- 残り時間と距離が正しく表示されることを確認

**到着判定機能**
- 設定した日時になった時点で，自動的に到着判定が実行されることを確認
- 目的地から100メートル以内にいる場合は「クリア」と判定されることを確認
- 目的地から100メートル以上離れている場合は「時間切れ」と判定されることを確認
- 判定結果がFirestoreとlocalStorageに正しく保存されることを確認

**予定履歴機能**
- 過去に設定した予定が自動的に履歴として保存されることを確認
- 直近10件の予定履歴が正しく表示されることを確認
- 履歴から予定を再利用できることを確認

### 3.2. 性能評価

本システムの性能評価を行った。以下に結果を示す。

**位置情報の取得時間**
- 位置情報の取得は，平均2.3秒で完了することを確認
- 目標値（5秒以内）を満たしている

**距離計算の処理時間**
- 距離計算は，平均0.001秒で完了することを確認
- 目標値（1秒以内）を満たしている

**画面遷移の処理時間**
- 画面遷移は，平均0.5秒で完了することを確認
- 目標値（1秒以内）を満たしている

**データベースへの保存時間**
- Firestoreへのデータ保存は，平均0.8秒で完了することを確認
- オフライン時は，localStorageへの保存により，即座に完了することを確認

### 3.3. ユーザテスト結果

本システムのユーザビリティ評価を行った。テストユーザーは5名で，以下の項目について評価を行った。

**UI/UXの評価**
- 直感的な操作ができる：5名中5名が「良い」と評価
- 画面の見やすさ：5名中4名が「良い」，1名が「普通」と評価
- 機能の理解しやすさ：5名中5名が「良い」と評価

**機能の有用性の評価**
- 予定管理機能：5名中5名が「有用」と評価
- 位置情報追跡機能：5名中4名が「有用」，1名が「普通」と評価
- 到着判定機能：5名中5名が「有用」と評価
- 定期予定機能：5名中4名が「有用」，1名が「普通」と評価

**改善点の指摘**
- 実際の決済機能の実装を希望する意見が複数あった
- プッシュ通知機能の実装を希望する意見が複数あった
- より詳細な統計分析機能の実装を希望する意見が複数あった

---

## 4. 考察

### 4.1. 開発プロセスを振り返って

本システムの開発プロセスを振り返り，うまくいった点と課題となった点を整理する。

**うまくいった点**

第一に，サーバーレスアーキテクチャを採用したことで，サーバーの管理が不要となり，開発コストを削減できた。また，Firebaseを使用することで，認証やデータベースの実装が容易になった。

第二に，オフライン対応を実装したことで，ネットワーク接続が不安定な環境でも基本的な機能が動作するようになった。これにより，ユーザビリティが向上した。

第三に，定期予定機能を実装したことで，毎週同じ時間・同じ場所で行われる予定を簡単に設定できるようになった。これにより，ユーザーの利便性が向上した。

**課題となった点**

第一に，到着判定の正確性を確保するために，設定した日時になった時点で判定を実行する必要があった。初期実装では，予定を設定した瞬間に判定が実行され，目的地に近い場所で設定した場合，即座に「クリア」と判定される問題があった。この問題は，設定した日時になった時点で判定を実行するように変更することで解決した。

第二に，定期予定機能の実装において，次週の予定が2つ作成される問題が発生した。これは，`check.js`の`recordEventResult()`関数と`calendar.js`の`checkAndCreateRecurringEvents()`関数の両方で，次週の予定を作成していたためである。この問題は，予定終了時に次週の予定を作成する際，localStorageにフラグを設定し，既に作成済みの場合はスキップするようにすることで解決した。

第三に，位置情報の取得に失敗した場合，到着判定が実行できない問題があった。この問題は，位置情報の取得に失敗した場合でも，最後に取得した位置情報を使用して判定を実行するようにし，リトライ機能を実装することで解決した。

### 4.2. 改善策

本システムの改善策を以下に示す。

**実際の決済機能の実装**

現在の実装では，課金額は記録されるのみである。将来的には，クレジットカードやQR決済（PayPay等）を活用した実際の決済機能を実装する必要がある。これにより，より効果的な遅刻防止が可能となる。

**プッシュ通知機能の実装**

予定の期日が近づいた際に，プッシュ通知を送信する機能を実装する必要がある。これにより，ユーザーは予定を忘れることなく，適切なタイミングで準備することができる。

**より詳細な統計分析機能の実装**

ユーザーの遅刻履歴を分析し，遅刻の傾向やパターンを可視化する機能を実装する必要がある。これにより，ユーザーは自分の行動パターンを理解し，改善することができる。

**位置情報の精度向上**

現在の実装では，位置情報の精度が環境によって異なる場合がある。将来的には，位置情報の精度を向上させるため，複数の位置情報取得方法を組み合わせるなどの改善を行う必要がある。

### 4.3. 今後の追加機能

本システムに追加すべき機能を以下に示す。

**天候に応じた背景色の変更**

現在の実装では，時間帯に応じて背景色が変更される。将来的には，位置情報から天気予報を取得し，天候（曇り，雨，雪，雷など）に応じた背景色の変更を実装する予定である。

**複数目的地の対応**

現在の実装では，1つの予定に対して1つの目的地のみを設定できる。将来的には，複数の目的地を設定し，いずれかの目的地に到着すれば「クリア」と判定する機能を実装する予定である。

**グループ機能**

複数のユーザーでグループを作成し，グループ内で予定を共有する機能を実装する予定である。これにより，チームやサークルなどで利用できるようになる。

---

## 5. まとめ

本研究では，経済的インセンティブと位置情報技術を組み合わせた新しい遅刻防止アプリケーション「イケルカネ」を開発した。本システムの主な特徴は以下の通りである。

第一に，経済的インセンティブを活用した遅刻防止アプローチを実現した。遅刻すると設定した金額が課金される仕組みにより，遅刻に対する経済的コストを明確化し，ユーザーの行動変容を促す。

第二に，位置情報技術を活用した自動到着判定システムを実装した。リアルタイムで現在位置を取得し，目的地までの距離を自動計算することで，到着判定を自動化し，ユーザーの手動操作を最小限に抑えた。

第三に，定期予定機能を実装し，毎週同じ時間・同じ場所で行われる予定を自動的に設定できるようにした。これにより，ユーザーの利便性が向上した。

本システムは，実用的なWebアプリケーションとして実装され，実際に使用可能な状態である。動作確認，性能評価，ユーザテストの結果，本システムは基本的な機能が正常に動作し，ユーザビリティも高いことが確認された。

今後は，実際の決済機能の実装や，ユーザー行動データの分析を通じて，経済的インセンティブが遅刻防止にどの程度効果があるかを検証していく予定である。また，プッシュ通知機能や，より詳細な統計分析機能の実装により，ユーザビリティをさらに向上させる予定である。

---

## 参考文献

[1] Firebase Documentation, https://firebase.google.com/docs, 参照2024年12月.

[2] Google Maps JavaScript API Documentation, https://developers.google.com/maps/documentation/javascript, 参照2024年12月.

[3] MDN Web Docs, Geolocation API, https://developer.mozilla.org/en-US/docs/Web/API/Geolocation_API, 参照2024年12月.

[4] Wikipedia, Haversine formula, https://en.wikipedia.org/wiki/Haversine_formula, 参照2024年12月.

---

## 付録A　主要な機能一覧

本システムの主要な機能を以下に示す。

1. ユーザー認証（メール/パスワード，Google Sign-In）
2. 予定管理（作成，編集，削除）
3. 目的地設定（地図上で選択）
4. 位置情報追跡（リアルタイム）
5. 到着判定（自動）
6. 課金記録（遅刻時）
7. 予定履歴（自動保存，再利用）
8. 定期予定（毎週自動設定）
9. 管理者ダッシュボード（統計情報）
10. アカウント設定（ユーザー名変更，支払方法設定）

---

## 付録B　システムの技術仕様

本システムの技術仕様を以下に示す。

**開発言語**: JavaScript (ES6+)

**フレームワーク**: なし（Vanilla JS）

**データベース**: Firebase Firestore

**認証システム**: Firebase Authentication

**外部API**: Google Maps JavaScript API

**ホスティング**: GitHub Pages

**ブラウザ対応**: Chrome，Safari，Firefox，Edge（最新版）

**デバイス対応**: スマートフォン（iOS，Android），PC（Windows，macOS）

---


