# イケルカネ - お金の抑止力で遅刻をさせない
## 位置情報を活用した遅刻防止アプリケーションの開発

---

## 1. はじめに

現代社会において、時間を守ることは信頼関係を構築する上で重要な要素である。しかし、約束の時間に遅れることは、個人の自己管理能力や信頼性に影響を与える問題として存在している。本論文では、経済的インセンティブと位置情報技術を組み合わせた新しい遅刻防止アプリケーション「イケルカネ」の開発について述べる。

イケルカネは、「お金の抑止力で遅刻をさせない」というコンセプトのもと、位置情報技術を活用して自動的に到着を判定し、遅刻した場合には設定した金額が課金される仕組みを実装したWebアプリケーションである。本システムは、単なる意識改革ではなく、経済的インセンティブを活用することで、より効果的な遅刻防止を実現することを目的としている。

---

## 2. 研究背景・問題提起

### 2.1 遅刻問題の現状

約束の時間に遅れることは、個人の信頼関係に大きな影響を与える。特に、ビジネスシーンや学業において、時間を守ることは基本的なマナーとして求められる。しかし、自己管理が難しい場面や、緊急事態が発生した場合など、様々な要因により遅刻が発生することがある。

従来の遅刻防止のアプローチとしては、アラーム機能やカレンダーアプリケーションなどが存在するが、これらは主に「意識改革」に依存しており、実際の行動変容を促すには不十分な場合がある。

### 2.2 解決アプローチ

本研究では、経済的インセンティブを活用した新しい遅刻防止アプローチを提案する。具体的には、以下の3つの要素を組み合わせることで、より効果的な遅刻防止を実現する。

1. **経済的インセンティブ**: 遅刻すると設定した金額が課金される仕組みにより、遅刻に対する経済的コストを明確化する
2. **位置情報技術**: リアルタイムで現在位置を取得し、目的地までの距離を自動計算することで、到着判定を自動化する
3. **自動検知システム**: 設定した日時になった時点で、自動的に到着判定を実行し、ユーザーの手動操作を最小限に抑える

---

## 3. システム概要

### 3.1 コンセプト

イケルカネのコンセプトは、「お金の抑止力で遅刻をさせない」である。ユーザーは予定を登録する際に、目的地と期日、そして遅刻した場合の課金額を設定する。予定の期日になった時点で、システムが自動的に現在位置を取得し、目的地から100メートル以内にいるかどうかを判定する。目的地に到着していれば課金は発生せず、到着していなければ設定した金額が課金される。

### 3.2 主な機能

#### 3.2.1 予定管理機能

ユーザーはカレンダー形式のインターフェースで予定を登録・管理することができる。予定には以下の情報が含まれる：

- **予定タイトル**: 会議、打ち合わせ、約束などの予定名
- **期日**: 到着すべき日時（年月日と時刻）
- **目的地**: 地図上で指定した緯度・経度
- **課金額**: 遅刻した場合に課金される金額（100円以上）

また、定期予定機能により、毎週同じ時間・同じ場所で行われる予定（例：講義）を自動的に設定することができる。定期予定を設定すると、今週の予定が終了した時点で、次週の予定が自動的に作成される。

#### 3.2.2 位置情報追跡機能

予定の期日が近づくと、システムは自動的に位置情報の取得を開始する。主な機能は以下の通りである：

- **リアルタイム位置情報取得**: `navigator.geolocation.watchPosition()`を使用して、継続的に現在位置を取得
- **距離計算**: Haversine formula（球面距離計算）を使用して、目的地までの距離を正確に計算
- **到着予測**: 残り時間と距離を表示し、ユーザーに到着予測時間を提供
- **自動到着判定**: 設定した日時になった時点で、その時点の位置情報で到着判定を実行

#### 3.2.3 課金システム

到着判定は、設定した日時になった時点で一度だけ実行される。判定の結果は以下の通りである：

- **到着成功（クリア）**: 目的地から100メートル以内にいる場合、課金は発生せず、予定は「完了」として記録される
- **遅刻（時間切れ）**: 目的地から100メートル以上離れている場合、設定した金額が課金され、予定は「失敗」として記録される

現在の実装では、課金額は記録されるのみであり、実際の決済機能は未実装である。将来的には、クレジットカードやQR決済（PayPay等）を活用した実際の決済機能の実装を予定している。

#### 3.2.4 予定履歴機能

過去に設定した予定は、自動的に履歴として保存される。履歴には、予定タイトル、目的地の位置情報、課金額が含まれ、再利用することができる。直近10件の予定履歴が表示され、クリックすることで予定入力フォームに自動入力される。

#### 3.2.5 統計・管理機能

- **個人の遅刻履歴**: ユーザーは自分の予定の完了・失敗履歴を確認できる
- **管理者ダッシュボード**: 特定の管理者ユーザー（uriuri4321@gmail.com）は、全ユーザーの統計情報を確認できる

---

## 4. 技術的実装

### 4.1 技術スタック

#### 4.1.1 フロントエンド

- **HTML5 / CSS3 / JavaScript（Vanilla JS）**: フレームワークを使用せず、純粋なJavaScriptで実装
- **レスポンシブデザイン**: スマートフォンとPCの両方に対応したUI設計
- **Google Maps JavaScript API**: 地図表示、位置検索、距離計算に使用

#### 4.1.2 バックエンド・データベース

- **Firebase Authentication**: ユーザー認証システム（メール/パスワード認証、Google Sign-In対応）
- **Firebase Firestore**: NoSQLクラウドデータベース
  - 予定データ、位置情報履歴、課金情報を保存
  - 複数デバイス間でのデータ同期を実現
  - リアルタイムデータ更新に対応

#### 4.1.3 外部API

- **Google Maps JavaScript API**: 地図表示、位置検索、距離計算
- **Google Places API**: 場所の自動補完機能（実装予定）

### 4.2 システムアーキテクチャ

本システムは、サーバーレスアーキテクチャを採用している。具体的には、以下の特徴を持つ：

- **クライアントサイド処理**: 位置情報の取得、距離計算、UI更新などの処理は、すべてクライアント側（ブラウザ）で実行される
- **クラウドデータベース**: Firestoreを使用して、予定データやユーザー情報をクラウド上に保存
- **オフライン対応**: localStorageをキャッシュとして使用し、オフライン時でも基本的な機能が動作する

### 4.3 位置情報の取得と処理

#### 4.3.1 位置情報の取得方法

位置情報の取得には、Web Geolocation APIを使用している。具体的な実装は以下の通りである：

```javascript
// 継続的な位置情報の監視
navigator.geolocation.watchPosition(
    function(position) {
        const currentLat = position.coords.latitude;
        const currentLng = position.coords.longitude;
        // 位置情報の更新処理
    },
    function(error) {
        // エラーハンドリング
    },
    {
        enableHighAccuracy: true,
        timeout: 30000,
        maximumAge: 5000
    }
);
```

#### 4.3.2 距離計算アルゴリズム

目的地までの距離は、Haversine formula（球面距離計算）を使用して計算される。このアルゴリズムは、地球を球面として扱い、緯度・経度から正確な距離を計算する。

```javascript
// Haversine formulaによる距離計算（km単位）
const distance = 6371 * Math.acos(
    Math.cos(targetLat*R) * Math.cos(nowLat*R) * Math.cos(nowLng*R - targetLng*R) +
    Math.sin(targetLat*R) * Math.sin(nowLat*R)
);
```

ここで、`R = Math.PI / 180`は度からラジアンへの変換係数、`6371`は地球の半径（km）である。

#### 4.3.3 到着判定の実装

到着判定は、設定した日時になった時点で一度だけ実行される。判定の流れは以下の通りである：

1. **時刻チェック**: `updateTime()`関数が1秒ごとに実行され、設定した日時になったかどうかをチェック
2. **位置情報取得**: 設定した日時になった時点で、最新の位置情報を取得
3. **距離計算**: 取得した位置情報と目的地の距離を計算
4. **判定実行**: 距離が100メートル以内であれば「クリア」、そうでなければ「時間切れ」として判定
5. **結果記録**: 判定結果をFirestoreとlocalStorageに保存

この実装により、設定した日時になった瞬間の位置情報で判定が行われるため、より公平で正確な判定が可能となる。

---

## 5. 実装のポイント・工夫

### 5.1 データ移行戦略

本システムでは、既存のlocalStorageデータをFirestoreに自動移行する機能を実装している。これにより、既存ユーザーのデータを失うことなく、クラウドデータベースへの移行が可能となる。また、オフライン時もlocalStorageで動作可能なため、ネットワーク接続が不安定な環境でも基本的な機能が利用できる。

### 5.2 定期予定機能の実装

定期予定機能は、毎週同じ時間・同じ場所で行われる予定（例：講義）を自動的に設定する機能である。実装のポイントは以下の通りである：

- **予定終了時の自動作成**: 今週の予定が終了（クリアまたは時間切れ）した時点で、次週の予定が自動的に作成される
- **重複防止**: 予定終了時に次週の予定を作成する際、既に作成済みの場合は重複作成を防止する
- **時間の正確性**: 次週の予定は、今週の予定と同じ時刻（例：15時）で作成されるため、時間のずれが発生しない

### 5.3 ユーザビリティの向上

#### 5.3.1 直感的なUI/UX設計

- **タブ形式のインターフェース**: 予定管理、予定履歴、使い方の3つのタブで機能を整理
- **視覚的フィードバック**: 残り時間、距離、現在位置をリアルタイムで表示
- **レスポンシブデザイン**: スマートフォンとPCの両方で最適な表示を実現

#### 5.3.2 時間帯に応じた背景色変更

時間帯（朝、昼、夕方、夜）に応じて、背景のグラデーション色が自動的に変更される。これにより、ユーザーは時間の経過を視覚的に認識できる。将来的には、位置情報から天気予報を取得し、天候に応じた背景色の変更も実装予定である。

#### 5.3.3 予定履歴の自動保存

過去に設定した予定は、自動的に履歴として保存される。これにより、ユーザーは同じ予定を簡単に再利用できる。履歴には、予定タイトル、目的地の位置情報、課金額が含まれ、クリックするだけで予定入力フォームに自動入力される。

### 5.4 セキュリティの実装

#### 5.4.1 ユーザー認証

Firebase Authenticationを使用して、安全なユーザー認証を実装している。メール/パスワード認証とGoogle Sign-Inの両方に対応しており、ユーザーは好みの方法でログインできる。

#### 5.4.2 データ分離

Firestoreのセキュリティルールにより、ユーザーは自分のデータのみにアクセスできる。管理者ユーザー（uriuri4321@gmail.com）のみが、全ユーザーのデータにアクセスできる。

#### 5.4.3 位置情報の取り扱い

位置情報は、予定の到着判定にのみ使用され、他の目的には使用されない。また、位置情報はユーザーの同意を得た上で取得される。

---

## 6. システムの動作フロー

### 6.1 ユーザー側の流れ

1. **アカウント登録・ログイン**: メール/パスワードまたはGoogleアカウントでログイン
2. **予定登録**: カレンダー画面で予定タイトルと期日を入力
3. **目的地設定**: 地図画面で目的地を選択し、課金額を設定
4. **予定当日**: アプリを開くと自動的に位置情報の追跡が開始される
5. **到着判定**: 設定した日時になった時点で、自動的に到着判定が実行される
6. **結果確認**: 到着成功の場合は課金なし、遅刻の場合は課金額が記録される

### 6.2 技術的な処理フロー

1. **位置情報の取得**: `navigator.geolocation.watchPosition()`を使用して、継続的に位置情報を取得
2. **距離計算**: 取得した位置情報と目的地の距離を、Haversine formulaで計算
3. **時刻チェック**: `updateTime()`関数が1秒ごとに実行され、設定した日時になったかどうかをチェック
4. **到着判定**: 設定した日時になった時点で、その時点の位置情報で到着判定を実行
5. **結果記録**: 判定結果をFirestoreとlocalStorageに保存

### 6.3 定期予定の処理フロー

1. **定期予定の設定**: 予定登録時に「定期予定」チェックボックスにチェックを入れる
2. **予定終了時の処理**: 今週の予定が終了（クリアまたは時間切れ）した時点で、`recordEventResult()`関数が実行される
3. **次週予定の作成**: `createNextWeekRecurringEvent()`関数により、次週の予定が自動的に作成される
4. **重複防止**: 既に作成済みの場合は、重複作成を防止する

---

## 7. 実装における課題と解決策

### 7.1 到着判定の正確性

#### 7.1.1 課題

初期実装では、予定を設定した瞬間に到着判定が実行され、目的地に近い場所で設定した場合、即座に「クリア」と判定される問題があった。

#### 7.1.2 解決策

設定した日時になった時点で、その時点の位置情報で到着判定を実行するように変更した。具体的には、`updateTime()`関数が1秒ごとに実行され、設定した日時になった時点で、最新の位置情報を取得して判定を実行する。

### 7.2 定期予定の重複作成

#### 7.2.1 課題

定期予定機能の実装において、次週の予定が2つ作成される問題が発生した。これは、`check.js`の`recordEventResult()`関数と`calendar.js`の`checkAndCreateRecurringEvents()`関数の両方で、次週の予定を作成していたためである。

#### 7.2.2 解決策

予定終了時に次週の予定を作成する際、localStorageにフラグを設定し、`calendar.js`の`checkAndCreateRecurringEvents()`関数で、既に作成済みの場合はスキップするようにした。これにより、重複作成を防止している。

### 7.3 位置情報の取得失敗への対応

#### 7.3.1 課題

位置情報の取得に失敗した場合、到着判定が実行できない問題があった。

#### 7.3.2 解決策

位置情報の取得に失敗した場合でも、最後に取得した位置情報を使用して判定を実行するようにした。また、位置情報の取得にはリトライ機能を実装し、最大5回まで再試行するようにした。

---

## 8. 今後の展開

### 8.1 機能の拡張

#### 8.1.1 実際の決済機能の実装

現在の実装では、課金額は記録されるのみである。将来的には、クレジットカードやQR決済（PayPay等）を活用した実際の決済機能を実装する予定である。これにより、より効果的な遅刻防止が可能となる。

#### 8.1.2 プッシュ通知機能

予定の期日が近づいた際に、プッシュ通知を送信する機能を実装する予定である。これにより、ユーザーは予定を忘れることなく、適切なタイミングで準備することができる。

#### 8.1.3 より詳細な統計分析

ユーザーの遅刻履歴を分析し、遅刻の傾向やパターンを可視化する機能を実装する予定である。これにより、ユーザーは自分の行動パターンを理解し、改善することができる。

### 8.2 研究としての展開

#### 8.2.1 ユーザー行動データの分析

本システムを使用するユーザーの行動データを分析し、経済的インセンティブが遅刻防止にどの程度効果があるかを検証する。具体的には、課金額と遅刻率の相関関係を分析する。

#### 8.2.2 心理学的アプローチの効果測定

経済的インセンティブが、ユーザーの心理にどのような影響を与えるかを測定する。例えば、課金額が高い場合と低い場合で、遅刻率にどのような違いがあるかを検証する。

#### 8.2.3 ユーザーフィードバックの収集

実際に本システムを使用したユーザーからフィードバックを収集し、システムの改善点を特定する。また、ユーザーの満足度や継続使用意向を調査する。

---

## 9. まとめ

本研究では、経済的インセンティブと位置情報技術を組み合わせた新しい遅刻防止アプリケーション「イケルカネ」を開発した。本システムの主な特徴は以下の通りである：

1. **経済的インセンティブの活用**: 遅刻すると設定した金額が課金される仕組みにより、遅刻に対する経済的コストを明確化
2. **位置情報技術の活用**: リアルタイムで現在位置を取得し、目的地までの距離を自動計算することで、到着判定を自動化
3. **自動検知システム**: 設定した日時になった時点で、自動的に到着判定を実行し、ユーザーの手動操作を最小限に抑える

本システムは、実用的なWebアプリケーションとして実装され、実際に使用可能な状態である。今後は、実際の決済機能の実装や、ユーザー行動データの分析を通じて、経済的インセンティブが遅刻防止にどの程度効果があるかを検証していく予定である。

---

## 参考文献

- Firebase Documentation: https://firebase.google.com/docs
- Google Maps JavaScript API Documentation: https://developers.google.com/maps/documentation/javascript
- Web Geolocation API: https://developer.mozilla.org/en-US/docs/Web/API/Geolocation_API
- Haversine formula: https://en.wikipedia.org/wiki/Haversine_formula

---

## 付録

### 付録A: システムの技術仕様

- **開発言語**: JavaScript (ES6+)
- **フレームワーク**: なし（Vanilla JS）
- **データベース**: Firebase Firestore
- **認証システム**: Firebase Authentication
- **外部API**: Google Maps JavaScript API
- **ホスティング**: GitHub Pages

### 付録B: 主要な機能一覧

1. ユーザー認証（メール/パスワード、Google Sign-In）
2. 予定管理（作成、編集、削除）
3. 目的地設定（地図上で選択）
4. 位置情報追跡（リアルタイム）
5. 到着判定（自動）
6. 課金記録（遅刻時）
7. 予定履歴（自動保存、再利用）
8. 定期予定（毎週自動設定）
9. 管理者ダッシュボード（統計情報）
10. アカウント設定（ユーザー名変更、支払方法設定）

---

